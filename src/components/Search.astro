---
/**
 * Search - Pagefind-powered static search with modal UI
 * Keyboard shortcut: ⌘K or Ctrl+K
 */
---

<button class="search-trigger" aria-label="Search" title="Search (⌘K)">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.3-4.3"></path>
  </svg>
  <span class="search-text">Search</span>
  <kbd class="search-kbd">⌘K</kbd>
</button>

<dialog id="search-modal" class="search-modal">
  <div class="search-container">
    <div class="search-header">
      <div class="search-input-wrapper">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input
          type="search"
          id="search-input"
          class="search-input"
          placeholder="Search posts..."
          autocomplete="off"
        />
        <button class="search-close" aria-label="Close search">
          <kbd>Esc</kbd>
        </button>
      </div>
    </div>
    <div id="search-results" class="search-results"></div>
    <div class="search-footer">
      <span class="search-hint">
        <kbd>↑</kbd><kbd>↓</kbd> to navigate
        <kbd>↵</kbd> to select
        <kbd>Esc</kbd> to close
      </span>
      <span class="search-powered">Powered by Pagefind</span>
    </div>
  </div>
</dialog>

<script is:inline>
  let pagefind = null

  async function loadPagefind() {
    if (pagefind) return pagefind
    try {
      // Dynamic import at runtime - Pagefind files are generated during build
      pagefind = await import('/pagefind/pagefind.js')
      await pagefind.init()
      return pagefind
    } catch (e) {
      console.error('Failed to load Pagefind:', e)
      return null
    }
  }

  function initSearch() {
    const trigger = document.querySelector('.search-trigger')
    const modal = document.getElementById('search-modal')
    const input = document.getElementById('search-input')
    const results = document.getElementById('search-results')
    const closeBtn = modal?.querySelector('.search-close')

    if (!trigger || !modal || !input || !results) return

    let selectedIndex = -1
    let resultLinks = []

    function openModal() {
      modal.showModal()
      input.focus()
      loadPagefind()
    }

    function closeModal() {
      modal.close()
      input.value = ''
      results.innerHTML = ''
      selectedIndex = -1
    }

    function selectResult(index: number) {
      resultLinks.forEach((link, i) => {
        link.classList.toggle('selected', i === index)
      })
      if (resultLinks[index]) {
        resultLinks[index].scrollIntoView({ block: 'nearest' })
      }
    }

    async function performSearch(query: string) {
      if (!query.trim()) {
        results.innerHTML = '<div class="search-empty">Type to search...</div>'
        return
      }

      const pf = await loadPagefind()
      if (!pf) {
        results.innerHTML = '<div class="search-empty">Search unavailable</div>'
        return
      }

      const search = await pf.search(query)
      if (search.results.length === 0) {
        results.innerHTML = '<div class="search-empty">No results found</div>'
        return
      }

      const items = await Promise.all(
        search.results.slice(0, 8).map((r) => r.data())
      )

      results.innerHTML = items
        .map(
          (item) => `
          <a href="${item.url}" class="search-result">
            <span class="result-title">${item.meta?.title || 'Untitled'}</span>
            <span class="result-excerpt">${item.excerpt}</span>
          </a>
        `
        )
        .join('')

      resultLinks = Array.from(results.querySelectorAll('.search-result'))
      selectedIndex = -1
    }

    // Event listeners
    trigger.addEventListener('click', openModal)
    closeBtn?.addEventListener('click', closeModal)

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal()
    })

    input.addEventListener('input', (e) => {
      performSearch((e.target as HTMLInputElement).value)
    })

    input.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') {
        e.preventDefault()
        selectedIndex = Math.min(selectedIndex + 1, resultLinks.length - 1)
        selectResult(selectedIndex)
      } else if (e.key === 'ArrowUp') {
        e.preventDefault()
        selectedIndex = Math.max(selectedIndex - 1, 0)
        selectResult(selectedIndex)
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault()
        resultLinks[selectedIndex]?.click()
      }
    })

    // Global keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        if (modal.open) {
          closeModal()
        } else {
          openModal()
        }
      }
      if (e.key === 'Escape' && modal.open) {
        closeModal()
      }
    })

    // Show initial state
    results.innerHTML = '<div class="search-empty">Type to search...</div>'
  }

  initSearch()
  document.addEventListener('astro:after-swap', initSearch)
</script>

<style>
  .search-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all var(--transition-fast) ease;
  }

  .search-trigger:hover {
    border-color: var(--sip-primary);
    color: var(--sip-primary);
  }

  .search-text {
    display: none;
  }

  .search-kbd {
    display: none;
    padding: 0.125rem 0.375rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-family: inherit;
    color: var(--text-tertiary);
  }

  @media (min-width: 640px) {
    .search-text,
    .search-kbd {
      display: inline;
    }
  }

  .search-modal {
    position: fixed;
    inset: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
  }

  .search-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .search-container {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .search-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-primary);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .search-icon {
    flex-shrink: 0;
    color: var(--text-tertiary);
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    font-size: 1.125rem;
    color: var(--text-primary);
    outline: none;
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .search-close {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .search-close kbd {
    padding: 0.25rem 0.5rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--text-tertiary);
  }

  .search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .search-empty {
    padding: 2rem;
    text-align: center;
    color: var(--text-tertiary);
  }

  .search-result {
    display: block;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: background var(--transition-fast) ease;
  }

  .search-result:hover,
  .search-result.selected {
    background: var(--bg-tertiary);
  }

  .result-title {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .result-excerpt {
    display: block;
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .result-excerpt :global(mark) {
    background: rgba(99, 102, 241, 0.2);
    color: var(--sip-primary);
    padding: 0 0.125rem;
    border-radius: 2px;
  }

  .search-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-primary);
    background: var(--bg-tertiary);
  }

  .search-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-tertiary);
  }

  .search-hint kbd {
    padding: 0.125rem 0.375rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
  }

  .search-powered {
    font-size: 0.6875rem;
    color: var(--text-muted);
  }

  @media (max-width: 640px) {
    .search-container {
      top: 5%;
      width: 95%;
    }

    .search-footer {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>
