---
/**
 * TableOfContents - Auto-generated from headings with scroll spy
 * Displays h2/h3 hierarchy with active state tracking
 */
interface Heading {
  depth: number
  slug: string
  text: string
}

interface Props {
  headings: Heading[]
  title?: string
}

const { headings, title = 'On This Page' } = Astro.props

// Filter to only h2 and h3
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3)
---

{
  tocHeadings.length > 2 && (
    <nav class="toc" aria-label="Table of contents">
      <button class="toc-toggle" aria-expanded="true" aria-controls="toc-list">
        <span class="toc-title">{title}</span>
        <svg
          class="toc-chevron"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <polyline points="6 9 12 15 18 9" />
        </svg>
      </button>
      <ul id="toc-list" class="toc-list">
        {tocHeadings.map((heading) => (
          <li class:list={['toc-item', `depth-${heading.depth}`]}>
            <a href={`#${heading.slug}`} class="toc-link" data-heading={heading.slug}>
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<style>
  .toc {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 1rem 1.25rem;
    margin: 1.5rem 0;
  }

  .toc-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    color: var(--text-primary);
  }

  .toc-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--sip-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .toc-chevron {
    color: var(--text-tertiary);
    transition: transform var(--transition-fast) ease;
  }

  .toc-toggle[aria-expanded='false'] .toc-chevron {
    transform: rotate(-90deg);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0.75rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .toc-list.collapsed {
    display: none;
  }

  .toc-item {
    margin: 0;
  }

  .toc-item.depth-3 {
    padding-left: 1rem;
  }

  .toc-link {
    display: block;
    position: relative;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    line-height: 1.5;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast) ease;
    border-left: 2px solid transparent;
    margin-left: -0.75rem;
  }

  .toc-link:hover {
    color: var(--sip-primary);
    background: rgba(99, 102, 241, 0.08);
  }

  .toc-link.active {
    color: var(--sip-primary);
    background: rgba(99, 102, 241, 0.1);
    border-left-color: var(--sip-primary);
    font-weight: 500;
  }

  .depth-3 .toc-link {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
  }

  .depth-3 .toc-link:hover,
  .depth-3 .toc-link.active {
    color: var(--sip-primary);
  }

  @media (max-width: 768px) {
    .toc {
      padding: 0.875rem 1rem;
    }
  }
</style>

<script>
  function initTableOfContents() {
    const toc = document.querySelector('.toc')
    if (!toc) return

    const toggle = toc.querySelector('.toc-toggle')
    const list = toc.querySelector('.toc-list')
    const links = toc.querySelectorAll('.toc-link')

    // Toggle functionality
    toggle?.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true'
      toggle.setAttribute('aria-expanded', String(!isExpanded))
      list?.classList.toggle('collapsed', isExpanded)
    })

    // Scroll spy
    const headingIds = Array.from(links).map(
      (link) => link.getAttribute('data-heading') || ''
    )
    const headingElements = headingIds
      .map((id) => document.getElementById(id))
      .filter(Boolean) as HTMLElement[]

    if (headingElements.length === 0) return

    let currentActive: Element | null = null

    const observer = new IntersectionObserver(
      (entries) => {
        // Find the first visible heading
        const visibleEntries = entries.filter((entry) => entry.isIntersecting)

        if (visibleEntries.length > 0) {
          // Get the topmost visible heading
          const topEntry = visibleEntries.reduce((prev, curr) => {
            return prev.boundingClientRect.top < curr.boundingClientRect.top
              ? prev
              : curr
          })

          const id = topEntry.target.id
          const link = toc.querySelector(`[data-heading="${id}"]`)

          if (link && link !== currentActive) {
            currentActive?.classList.remove('active')
            link.classList.add('active')
            currentActive = link
          }
        }
      },
      {
        rootMargin: '-80px 0px -60% 0px',
        threshold: 0,
      }
    )

    headingElements.forEach((heading) => observer.observe(heading))

    // Set initial active state based on scroll position
    const setInitialActive = () => {
      const scrollTop = window.scrollY + 100
      let activeHeading: HTMLElement | null = null

      for (const heading of headingElements) {
        if (heading.offsetTop <= scrollTop) {
          activeHeading = heading
        } else {
          break
        }
      }

      if (activeHeading) {
        const link = toc.querySelector(`[data-heading="${activeHeading.id}"]`)
        if (link && link !== currentActive) {
          currentActive?.classList.remove('active')
          link.classList.add('active')
          currentActive = link
        }
      }
    }

    setInitialActive()

    // Cleanup on page transition
    document.addEventListener(
      'astro:before-swap',
      () => {
        observer.disconnect()
      },
      { once: true }
    )
  }

  // Run on load
  initTableOfContents()

  // Run after view transitions
  document.addEventListener('astro:after-swap', initTableOfContents)
</script>
