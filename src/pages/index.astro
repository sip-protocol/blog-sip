---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../layouts/BaseLayout.astro'
import HomepageHero from '../components/HomepageHero.astro'
import FeaturedPost from '../components/FeaturedPost.astro'
import PostCard from '../components/PostCard.astro'
import NewsletterCTA from '../components/NewsletterCTA.astro'
import SocialProof from '../components/SocialProof.astro'
import { SITE_DESCRIPTION } from '../consts'
import { getReadingTime } from '../utils/reading-time'

// Get all non-draft posts, sorted by date
const posts = (
  await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true
  })
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())

// Calculate reading time for each post
const postsWithReadingTime = await Promise.all(
  posts.map(async (post) => {
    const { remarkPluginFrontmatter } = await render(post)
    // Use body length estimate if no raw content available
    const wordCount = post.body?.split(/\s+/).length || 0
    const readingTime = Math.max(1, Math.ceil(wordCount / 200))
    return { ...post, readingTime }
  })
)

// Get featured post (first featured or most recent)
const featuredPost = postsWithReadingTime.find((p) => p.data.featured) || postsWithReadingTime[0]
const remainingPosts = postsWithReadingTime.filter((p) => p.id !== featuredPost?.id)
---

<BaseLayout>
  <HomepageHero />

  <SocialProof />

  {
    featuredPost && (
      <FeaturedPost
        title={featuredPost.data.title}
        description={featuredPost.data.description}
        pubDate={featuredPost.data.pubDate}
        heroImage={featuredPost.data.heroImage}
        slug={featuredPost.id}
        category={featuredPost.data.category}
        tags={featuredPost.data.tags}
        readingTime={featuredPost.readingTime}
      />
    )
  }

  <section class="posts" data-animate="fade-in">
    <h2 class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
      Latest Posts
    </h2>
    <div class="post-grid">
      {
        remainingPosts.map((post, index) => (
          <PostCard
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            heroImage={post.data.heroImage}
            slug={post.id}
            category={post.data.category}
            tags={post.data.tags}
            readingTime={post.readingTime}
            animationIndex={index}
          />
        ))
      }
    </div>
  </section>

  <NewsletterCTA />

  {
    posts.length === 0 && (
      <section class="empty">
        <p>No posts yet. Check back soon!</p>
      </section>
    )
  }
</BaseLayout>

<style>
  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-title svg {
    color: var(--sip-primary);
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-primary);
    margin-left: 0.75rem;
  }

  .posts {
    margin-bottom: 3rem;
  }

  .post-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .empty {
    text-align: center;
    padding: 4rem 0;
    color: var(--text-tertiary);
    font-style: italic;
  }

  @media (max-width: 768px) {
    .post-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
