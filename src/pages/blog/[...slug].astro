---
import { type CollectionEntry, getCollection, render } from 'astro:content'
import BlogPost from '../../layouts/BlogPost.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true
  })

  // Sort by date (newest first)
  const sortedPosts = posts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  )

  return sortedPosts.map((post, index) => {
    const prevPost = sortedPosts[index + 1] // Older post
    const nextPost = sortedPosts[index - 1] // Newer post

    return {
      params: { slug: post.id },
      props: {
        post,
        prevPost: prevPost
          ? { slug: prevPost.id, title: prevPost.data.title }
          : undefined,
        nextPost: nextPost
          ? { slug: nextPost.id, title: nextPost.data.title }
          : undefined,
      },
    }
  })
}

interface Props {
  post: CollectionEntry<'blog'>
  prevPost?: { slug: string; title: string }
  nextPost?: { slug: string; title: string }
}

const { post, prevPost, nextPost } = Astro.props
const { Content, headings } = await render(post)

// Calculate reading time from body content
const wordCount = post.body?.split(/\s+/).length || 0
const readingTime = Math.max(1, Math.ceil(wordCount / 200))
---

<BlogPost {...post.data} slug={post.id} prevPost={prevPost} nextPost={nextPost} headings={headings} readingTime={readingTime}>
  <Content />
</BlogPost>
